# ============================================================================
# Production Docker Compose Configuration - Secure Deployment
# Sell The Old Car - Only Nginx exposes public ports
# ============================================================================

version: '3.8'

services:
  # --------------------------------------------------------------------------
  # Nginx Reverse Proxy - Only service with public exposure
  # --------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: car-selling-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - uploads-data:/var/www/uploads:ro
    networks:
      - backend
    depends_on:
      app:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # --------------------------------------------------------------------------
  # Application Service - Internal only
  # --------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: car-selling-app:latest
    container_name: car-selling-app
    restart: unless-stopped
    expose:
      - "8080"
    environment:
      # Database Configuration
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/carselling
      - SPRING_DATASOURCE_USERNAME=${DB_USERNAME:-car_user}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-car_password}
      
      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD:-}
      
      # Server Configuration
      - SERVER_PORT=8080
      - LOGGING_LEVEL_ROOT=${LOG_LEVEL:-INFO}
      
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_EXPIRATION=${JWT_ACCESS_EXPIRATION:-900000}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION:-604800000}
      
      # File Storage
      - STORAGE_UPLOAD_PATH=/app/uploads
      
      # B2 Configuration
      - B2_APPLICATION_KEY_ID=${B2_APPLICATION_KEY_ID}
      - B2_APPLICATION_KEY=${B2_APPLICATION_KEY}
      - B2_BUCKET_NAME=${B2_BUCKET_NAME}
      - B2_BUCKET_ID=${B2_BUCKET_ID}
      - B2_CDN_DOMAIN=${B2_CDN_DOMAIN}
      
      # OpenSearch Configuration
      - OPENSEARCH_HOST=opensearch
      - OPENSEARCH_PORT=9200
      - OPENSEARCH_USERNAME=${OPENSEARCH_USERNAME:-admin}
      - OPENSEARCH_PASSWORD=${OPENSEARCH_PASSWORD}
      
      # Email Configuration
      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_USERNAME=${EMAIL_USERNAME}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD}
      - EMAIL_FROM=${EMAIL_FROM}
    volumes:
      - uploads-data:/app/uploads
      - logs-data:/app/logs
      - ./config:/app/config:ro
    networks:
      - backend
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      opensearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # --------------------------------------------------------------------------
  # PostgreSQL Database - Internal only (NOT exposed publicly)
  # --------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: car-selling-postgres
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - POSTGRES_DB=carselling
      - POSTGRES_USER=${DB_USERNAME:-car_user}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-car_password}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init:/docker-entrypoint-initdb.d:ro
    expose:
      - "5432"
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-car_user} -d carselling"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # --------------------------------------------------------------------------
  # Redis Cache - Internal only
  # --------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: car-selling-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    expose:
      - "6379"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # --------------------------------------------------------------------------
  # OpenSearch - Internal only
  # --------------------------------------------------------------------------
  opensearch:
    image: opensearchproject/opensearch:2.12.0
    container_name: car-selling-opensearch
    restart: unless-stopped
    environment:
      - cluster.name=car-selling-cluster
      - node.name=car-selling-node
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - plugins.security.disabled=true
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_PASSWORD:-admin}
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    expose:
      - "9200"
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

# --------------------------------------------------------------------------
# Volumes
# --------------------------------------------------------------------------
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  opensearch-data:
    driver: local
  uploads-data:
    driver: local
  logs-data:
    driver: local

# --------------------------------------------------------------------------
# Networks
# --------------------------------------------------------------------------
networks:
  backend:
    driver: bridge
    internal: false


