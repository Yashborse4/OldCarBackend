# WebSocket Chat System Implementation

## Overview

This document describes the comprehensive WebSocket-based chat system implementation for the Car Selling platform. The system supports real-time messaging between users, dealers, and sellers with proper message status tracking, security features, and PostgreSQL-only persistence (no Redis dependency).

## Architecture

### Key Components

1. **WebSocket Configuration** (`WebSocketConfig.java`)
   - STOMP protocol support with JWT authentication
   - Secure WebSocket endpoints with authentication interceptors
   - Message broker configuration using simple in-memory broker

2. **Message Delivery Service** (`MessageDeliveryService.java`)
   - Comprehensive message status tracking (sent, delivered, read, failed)
   - Bulk delivery confirmations
   - Message delivery statistics and metrics

3. **Chat Security Service** (`ChatSecurityService.java`)
   - Rate limiting using Bucket4j
   - Spam detection and content validation
   - Input sanitization and security checks
   - Role-based permission management

4. **REST API Controller** (`ChatRestController.java`)
   - Complete REST API for chat operations
   - Message management endpoints
   - Status tracking and delivery statistics

5. **WebSocket Controller** (`ChatWebSocketController.java`)
   - Real-time message handling
   - Typing indicators and user presence
   - Message status updates

## Database Schema

### Core Tables

#### Users Table (existing)
- `id` (Primary Key)
- `username`
- `email`
- `password`
- `role` (VIEWER, DEALER, SELLER, ADMIN)

#### Chats Table
```sql
CREATE TABLE chats (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name VARCHAR(100) NOT NULL,
    description VARCHAR(500),
    type VARCHAR(20) NOT NULL, -- PRIVATE, GROUP, DEALER_ONLY, SELLER_ONLY, SUPPORT, CAR_INQUIRY
    created_by_id BIGINT NOT NULL REFERENCES users(id),
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    max_participants INTEGER,
    car_id BIGINT, -- Optional reference to car
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP,
    last_activity_at TIMESTAMP,
    
    INDEX idx_chat_type (type),
    INDEX idx_chat_created_by (created_by_id),
    INDEX idx_chat_created_at (created_at),
    INDEX idx_chat_active (is_active)
);
```

#### Messages Table
```sql
CREATE TABLE messages (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    chat_id BIGINT NOT NULL REFERENCES chats(id),
    sender_id BIGINT REFERENCES users(id), -- NULL for system messages
    content TEXT,
    message_type VARCHAR(20) NOT NULL DEFAULT 'TEXT', -- TEXT, IMAGE, FILE, SYSTEM, VOICE, LOCATION, CAR_REFERENCE, USER_REFERENCE
    reply_to_id BIGINT REFERENCES messages(id),
    is_edited BOOLEAN NOT NULL DEFAULT FALSE,
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE,
    edited_at TIMESTAMP,
    deleted_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP,
    metadata TEXT, -- JSON metadata
    file_url VARCHAR(500),
    file_name VARCHAR(255),
    file_size BIGINT,
    mime_type VARCHAR(100),
    
    INDEX idx_message_chat (chat_id),
    INDEX idx_message_sender (sender_id),
    INDEX idx_message_created_at (created_at),
    INDEX idx_message_type (message_type),
    INDEX idx_message_reply_to (reply_to_id),
    INDEX idx_message_chat_created (chat_id, created_at)
);
```

#### Message Status Table
```sql
CREATE TABLE message_status (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    message_id BIGINT NOT NULL REFERENCES messages(id),
    user_id BIGINT NOT NULL REFERENCES users(id),
    status VARCHAR(10) NOT NULL, -- SENT, DELIVERED, READ, FAILED
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    sent_at TIMESTAMP,
    delivered_at TIMESTAMP,
    read_at TIMESTAMP,
    updated_at TIMESTAMP,
    
    UNIQUE CONSTRAINT uk_message_user_status (message_id, user_id),
    INDEX idx_message_status_message (message_id),
    INDEX idx_message_status_user (user_id),
    INDEX idx_message_status_message_user (message_id, user_id),
    INDEX idx_message_status_status (status),
    INDEX idx_message_status_read_at (read_at)
);
```

#### Chat Participants Table
```sql
CREATE TABLE chat_participants (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    chat_id BIGINT NOT NULL REFERENCES chats(id),
    user_id BIGINT NOT NULL REFERENCES users(id),
    role VARCHAR(20) NOT NULL DEFAULT 'MEMBER', -- ADMIN, MODERATOR, MEMBER
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    joined_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    left_at TIMESTAMP,
    last_read_at TIMESTAMP,
    notifications_enabled BOOLEAN NOT NULL DEFAULT TRUE,
    is_muted BOOLEAN NOT NULL DEFAULT FALSE,
    
    UNIQUE CONSTRAINT uk_chat_user (chat_id, user_id),
    INDEX idx_chat_participant_chat (chat_id),
    INDEX idx_chat_participant_user (user_id),
    INDEX idx_chat_participant_active (chat_id, is_active),
    INDEX idx_chat_participant_role (role)
);
```

#### User Status Table
```sql
CREATE TABLE user_status (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id BIGINT NOT NULL UNIQUE REFERENCES users(id),
    status VARCHAR(20) NOT NULL DEFAULT 'OFFLINE', -- ONLINE, AWAY, BUSY, OFFLINE
    custom_status VARCHAR(100),
    last_active_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    session_id VARCHAR(255),
    
    INDEX idx_user_status_user (user_id),
    INDEX idx_user_status_status (status),
    INDEX idx_user_status_last_active (last_active_at)
);
```

## API Endpoints

### WebSocket Endpoints

#### Connection
- **Endpoint**: `/ws` (with SockJS fallback)
- **Endpoint**: `/ws-native` (native WebSocket)
- **Authentication**: JWT token in headers (Authorization: Bearer {token})

#### Message Mapping Endpoints

1. **Send Message**
   - **Destination**: `/app/chat/{chatId}/send`
   - **Payload**: `SendMessageRequest`
   - **Response**: Broadcasts to `/topic/chat/{chatId}`

2. **Edit Message**
   - **Destination**: `/app/message/{messageId}/edit`
   - **Payload**: `EditMessageRequest`
   - **Response**: Broadcasts edit notification

3. **Delete Message**
   - **Destination**: `/app/message/{messageId}/delete`
   - **Response**: Broadcasts deletion notification

4. **Mark Message as Read**
   - **Destination**: `/app/message/{messageId}/read`
   - **Response**: Sends read receipt to sender

5. **Mark Message as Delivered**
   - **Destination**: `/app/message/{messageId}/delivered`
   - **Response**: Sends delivery receipt to sender

6. **Mark Chat as Read**
   - **Destination**: `/app/chat/{chatId}/read`
   - **Response**: Updates read status for all messages

7. **Typing Indicator**
   - **Destination**: `/app/chat/{chatId}/typing`
   - **Payload**: `TypingIndicatorRequest`
   - **Response**: Broadcasts to chat participants

8. **Get Unread Count**
   - **Destination**: `/app/user/unread-count`
   - **Response**: Sent to `/user/queue/unread-count`

9. **Get Delivery Stats**
   - **Destination**: `/app/message/{messageId}/delivery-stats`
   - **Response**: Sent to `/user/queue/delivery-stats`

10. **Bulk Mark as Delivered**
    - **Destination**: `/app/messages/bulk-delivered`
    - **Payload**: `BulkDeliveryRequest`

### REST API Endpoints

#### Chat Management
- `GET /api/chat/my-chats` - Get user's chats
- `GET /api/chat/{chatId}` - Get chat details
- `POST /api/chat/private` - Create private chat
- `POST /api/chat/group` - Create group chat
- `POST /api/chat/{chatId}/participants` - Add participants
- `DELETE /api/chat/{chatId}/participants/{userId}` - Remove participant
- `POST /api/chat/{chatId}/leave` - Leave chat

#### Message Management
- `GET /api/chat/{chatId}/messages` - Get messages with pagination
- `POST /api/chat/{chatId}/messages` - Send message
- `PUT /api/chat/messages/{messageId}` - Edit message
- `DELETE /api/chat/messages/{messageId}` - Delete message
- `GET /api/chat/{chatId}/messages/search` - Search messages
- `GET /api/chat/{chatId}/media` - Get media messages
- `POST /api/chat/{chatId}/mark-read` - Mark messages as read

#### Status and Delivery
- `GET /api/chat/messages/{messageId}/status` - Get message status
- `GET /api/chat/messages/{messageId}/delivery-stats` - Get delivery statistics
- `GET /api/chat/unread-count` - Get unread count
- `GET /api/chat/unread-count/by-chat` - Get unread count by chat
- `POST /api/chat/messages/{messageId}/delivered` - Mark as delivered
- `POST /api/chat/messages/bulk-delivered` - Bulk mark as delivered

#### User Status
- `GET /api/chat/{chatId}/online-users` - Get online users in chat
- `POST /api/chat/user-status` - Update user status

## Security Features

### Rate Limiting
- **Message Rate Limit**: 30 messages per minute (configurable)
- **Chat Creation Rate Limit**: 10 chats per hour (configurable)
- **Implementation**: Bucket4j with in-memory token buckets

### Content Validation
- **Spam Detection**: Pattern-based spam detection
- **Profanity Filter**: Configurable word filtering
- **Input Sanitization**: XSS prevention and content sanitization
- **Duplicate Detection**: Prevents rapid duplicate messages

### Authentication & Authorization
- **JWT Authentication**: Secure WebSocket connections
- **Role-based Access**: Chat type restrictions (DEALER_ONLY, SELLER_ONLY)
- **Permission Checks**: Action-based permission validation

### Message Security
- **Content Length Limits**: Configurable maximum message length
- **File Upload Validation**: MIME type and size restrictions
- **Metadata Sanitization**: Safe handling of JSON metadata

## Configuration Properties

```properties
# Chat System Settings
app.chat.max-message-length=1000
app.chat.max-messages-per-minute=30
app.chat.max-chats-per-hour=10
app.chat.typing-timeout=10000
app.chat.online-timeout=300000
app.chat.spam-detection-enabled=true

# WebSocket Settings
spring.websocket.allowedOrigins=http://localhost:3000,http://localhost:8080
spring.websocket.broker.host=localhost
spring.websocket.broker.port=61613
```

## Usage Examples

### Frontend Integration

#### Connecting to WebSocket
```javascript
const stompClient = new StompJs.Client({
    brokerURL: 'ws://localhost:9000/ws',
    connectHeaders: {
        'Authorization': 'Bearer ' + jwtToken
    },
    debug: function (str) {
        console.log(str);
    },
    reconnectDelay: 5000,
    heartbeatIncoming: 4000,
    heartbeatOutgoing: 4000,
});

stompClient.onConnect = function (frame) {
    console.log('Connected: ' + frame);
    
    // Subscribe to chat messages
    stompClient.subscribe('/topic/chat/' + chatId, function (message) {
        const messageData = JSON.parse(message.body);
        handleNewMessage(messageData);
    });
    
    // Subscribe to personal message queue
    stompClient.subscribe('/user/queue/messages', function (message) {
        const notification = JSON.parse(message.body);
        handleMessageNotification(notification);
    });
    
    // Subscribe to delivery receipts
    stompClient.subscribe('/user/queue/delivery-receipts', function (message) {
        const receipt = JSON.parse(message.body);
        handleDeliveryReceipt(receipt);
    });
};

stompClient.activate();
```

#### Sending Messages
```javascript
function sendMessage(chatId, content, messageType = 'TEXT') {
    stompClient.publish({
        destination: '/app/chat/' + chatId + '/send',
        body: JSON.stringify({
            content: content,
            messageType: messageType
        })
    });
}
```

#### Marking Messages as Read
```javascript
function markMessageAsRead(messageId) {
    stompClient.publish({
        destination: '/app/message/' + messageId + '/read'
    });
}
```

#### Typing Indicators
```javascript
function sendTypingIndicator(chatId, isTyping) {
    stompClient.publish({
        destination: '/app/chat/' + chatId + '/typing',
        body: JSON.stringify({
            isTyping: isTyping
        })
    });
}
```

### REST API Usage

#### Fetching Chat Messages
```javascript
async function getChatMessages(chatId, page = 0, size = 50) {
    const response = await fetch(`/api/chat/${chatId}/messages?page=${page}&size=${size}`, {
        headers: {
            'Authorization': 'Bearer ' + jwtToken,
            'Content-Type': 'application/json'
        }
    });
    return await response.json();
}
```

#### Creating a Private Chat
```javascript
async function createPrivateChat(otherUserId, name) {
    const response = await fetch('/api/chat/private', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + jwtToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            otherUserId: otherUserId,
            name: name
        })
    });
    return await response.json();
}
```

## Message Status Flow

1. **SENT**: Message is created and saved to database
2. **DELIVERED**: Message is received by recipient's client
3. **READ**: Message is viewed/read by the recipient
4. **FAILED**: Message delivery failed (optional)

### Status Tracking Process

1. When a message is sent, `MessageStatus` entries are created for all recipients with status `SENT`
2. When recipient's client receives the message, it sends a delivery confirmation
3. When recipient views the message, it sends a read confirmation
4. Sender receives real-time notifications about status changes

## Performance Considerations

### Database Optimization
- Proper indexing on frequently queried columns
- Soft deletion for messages (avoid hard deletes)
- Cleanup jobs for old message statuses
- Pagination for message retrieval

### Memory Management
- Rate limiting bucket cleanup to prevent memory leaks
- Session management for WebSocket connections
- Efficient message broadcasting

### Scalability
- PostgreSQL-only implementation (no Redis dependency)
- Stateless service design
- Connection pooling for database access

## Monitoring and Metrics

### Available Metrics
- Active WebSocket connections
- Message throughput
- Rate limiting statistics
- Security incidents (spam detection)
- Message delivery rates

### Health Checks
- Database connectivity
- WebSocket broker status
- Security service status

## Error Handling

### Common Error Scenarios
- Authentication failures
- Rate limit exceeded
- Permission denied
- Message validation errors
- Network connectivity issues

### Error Response Format
```json
{
    "type": "ERROR",
    "message": "Error description",
    "timestamp": "2023-12-07T10:30:00Z"
}
```

## Security Best Practices

1. **Always validate JWT tokens** in WebSocket connections
2. **Implement rate limiting** to prevent abuse
3. **Sanitize user input** to prevent XSS attacks
4. **Use HTTPS** in production environments
5. **Validate file uploads** and restrict file types
6. **Monitor for spam** and suspicious activity
7. **Implement proper CORS** configuration
8. **Use secure WebSocket** (WSS) in production

## Deployment Notes

### Environment Variables
```
JWT_SECRET=your-secure-jwt-secret
DB_URL=jdbc:postgresql://localhost:5432/carselling
DB_USERNAME=your-db-username
DB_PASSWORD=your-db-password
WEBSOCKET_ALLOWED_ORIGINS=https://yourdomain.com
```

### Production Configuration
- Use WSS (secure WebSocket) connections
- Configure proper CORS origins
- Enable production logging levels
- Set up database connection pooling
- Configure proper rate limiting values
- Enable spam detection and content filtering

This implementation provides a comprehensive, secure, and scalable WebSocket chat system suitable for a car selling platform with proper user role management, message status tracking, and security features.
